<div class="property-container" *ngIf="!isLoading && !errorMessage">
    <!-- Image Slider with Navigation Arrows -->
    <div class="gallery-section" *ngIf="property && property.images && property.images.length > 0">
        <div class="image-slider">
            <img 
                [src]="property.images[currentImageIndex].imageUrl" 
                [alt]="title + ' - Image ' + (currentImageIndex + 1)"
                class="slider-image">
            
            <!-- Navigation Arrows -->
            <button class="slider-arrow prev" (click)="previousImage()" *ngIf="property.images.length > 1">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="slider-arrow next" (click)="nextImage()" *ngIf="property.images.length > 1">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Image Counter -->
            <span class="image-counter">{{ currentImageIndex + 1 }} / {{ property.images.length }}</span>
            
            <!-- Thumbnail Indicators -->
            <div class="thumbnail-indicators" *ngIf="property.images.length > 1">
                <div 
                    *ngFor="let img of property.images; let i = index" 
                    class="thumbnail-dot"
                    [class.active]="i === currentImageIndex"
                    (click)="goToImage(i)">
                </div>
            </div>
        </div>
    </div>

    <div class="content-layout">
        <main class="property-details">
            <!-- Header Section -->
            <div class="header-section">
                <!-- Price -->
                <div class="price-row">
                    <h1>{{ price | currency: currency :'symbol':'1.0-0' }}</h1>
                    <span class="installment-tag" *ngIf="rentPriceMonthly > 0">
                        {{ rentPriceMonthly | currency: currency :'symbol':'1.0-0' }} {{ 'PROPERTY_VIEW.MONTHLY_RENT' | translate }}
                    </span>
                    <span class="installment-tag" *ngIf="rentPriceMonthly === 0 && property?.purpose !== 'ForSale'">
                        {{ currency }} {{ installment }} / {{ installmentPeriod }}
                    </span>
                </div>

                <!-- Down Payment -->
                <div class="down-payment-row" *ngIf="rentPriceMonthly === 0 && property?.purpose !== 'ForSale'">
                    <span class="down-payment-badge">
                        üíµ {{ 'PROPERTY_VIEW.DOWN_PAYMENT' | translate }}: {{ currency }} {{ downPayment }}
                    </span>
                </div>

                <!-- Location -->
                <h2 class="location-title">{{ location }}</h2>

                <!-- Specs -->
                <div class="specs-horizontal">
                    <span class="spec-item" *ngIf="specs.beds > 0">
                        üõè {{ specs.beds }} {{ specs.beds > 1 ? ('PROPERTY_VIEW.BEDS' | translate) : ('PROPERTY_VIEW.BED' | translate) }}
                    </span>
                    <span class="spec-item" *ngIf="specs.baths > 0">
                        üõÅ {{ specs.baths }} {{ specs.baths > 1 ? ('PROPERTY_VIEW.BATHS' | translate) : ('PROPERTY_VIEW.BATH' | translate) }}
                    </span>
                    <span class="spec-item" *ngIf="specs.area > 0">
                        üìê {{ specs.area }} {{ 'PROPERTY_VIEW.SQ_M' | translate }}
                    </span>
                </div>

                <!-- Title & Description -->
                <div class="description-section">
                    <h3>{{ title }}</h3>
                    <ul class="desc-list" *ngIf="description.length > 0">
                        <li *ngFor="let line of description">{{ line }}</li>
                    </ul>
                </div>

                <!-- Property Info Table -->
                <section class="info-table">
                    <h3>{{ 'PROPERTY_VIEW.PROPERTY_INFO_TITLE' | translate }}</h3>
                    <div class="grid-info">
                        <div class="info-item" *ngFor="let item of propertySpecs">
                            <span class="label">{{ item.label }}</span>
                            <span class="value">{{ item.value }}</span>
                        </div>
                    </div>
                </section>

                <!-- Amenities -->
                <section class="amenities-section" *ngIf="property && property.amenities && property.amenities.length > 0">
                    <h3>{{ 'PROPERTY_VIEW.AMENITIES_TITLE' | translate }}</h3>
                    <div class="amenities-grid">
                        <div class="amenity-item" *ngFor="let amenity of property.amenities">
                            <i class="fa fa-check-circle" style="color: #28b16d;"></i>
                            {{ currentLang === 'en' ? (amenity.nameEn || amenity.name) : amenity.name }}
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Agent Card -->
            <div class="broker-card">
                <div class="broker-header">
                    <img [src]="agent.imageUrl || 'https://via.placeholder.com/80'" 
                         [alt]="agent.name" 
                         class="profile-pic">
                    <div class="broker-info">
                        <h3 class="agent-name" 
                            (click)="viewAgentProfile()" 
                            style="cursor: pointer; color: #28b16d; margin: 0;">
                            {{ agent.name }}
                        </h3>
                        <p class="agent-stats">{{ agent.activeListings }} {{ 'PROPERTY_VIEW.ACTIVE_LISTINGS' | translate }}</p>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn-call" (click)="callAgent()" *ngIf="agent.phone">
                        üìû {{ 'PROPERTY_VIEW.CALL' | translate }}
                    </button>
                    <button class="btn-email" (click)="emailAgent()" *ngIf="agent.email">
                        ‚úâ {{ 'PROPERTY_VIEW.EMAIL' | translate }}
                    </button>
                    <button class="btn-whatsapp" (click)="whatsappAgent()" *ngIf="agent.whatsapp">
                        üí¨ {{ 'PROPERTY_VIEW.WHATSAPP' | translate }}
                    </button>
                </div>
            </div>

            <!-- Save Property Button -->
            <div class="save-property-card">
                <button (click)="toggleSave()" class="save-btn" [class.saved]="isSaved">
                    <i class="fa" [class.fa-heart]="isSaved" [class.fa-heart-o]="!isSaved"></i>
                    {{ isSaved ? ('PROPERTY_VIEW.UNSAVE_PROPERTY' | translate) : ('PROPERTY_VIEW.SAVE_PROPERTY' | translate) }}
                </button>
            </div>

            <!-- Analytics Card -->
            <div class="analytics-card">
                <h3>{{ 'PROPERTY_VIEW.ANALYTICS_TITLE' | translate }}</h3>
                <div class="analytics-content">
                    <!-- <div class="stat-item">
                        <i class="fa fa-eye pe-2"></i>
                        <span class="stat-label">{{ 'PROPERTY_VIEW.VIEWS' | translate }}</span>
                        <span class="stat-value">{{ viewCount }}</span>
                    </div> -->
                    <div class="stat-item">
                        <!-- <i class="fa fa-whatsapp pe-2"></i> -->
                         <i class="fa-brands fa-whatsapp pe-2"></i>
                        <span class="stat-label">{{ 'PROPERTY_VIEW.WHATSAPP_CLICKS' | translate }}</span>
                        <span class="stat-value">{{ whatsappClickCount }}</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Similar Properties Section -->
    <section class="similar-properties-section" *ngIf="similarProperties.length > 0">
        <h2 class="section-title">{{ 'PROPERTY_VIEW.RECOMMENDED' | translate }}</h2>
        <div class="properties-grid">
            <div class="property-card" *ngFor="let prop of similarProperties" 
                 [routerLink]="['/propertyview', prop.id]"
                 (click)="incrementViewCount(prop.id)"> <!-- Track view when clicked -->
                <div class="card-image">
                    <img [src]="prop.mainImageUrl || 'https://via.placeholder.com/300x200'" 
                         [alt]="getSimilarPropertyTitle(prop)">
                    <span class="badge" *ngIf="prop.isFeatured">‚≠ê {{ 'LISTING_PROPERTIES.FEATURED' | translate }}</span>
                    <span class="purpose-badge" [class.rent]="prop.purpose === 'ForRent'">
                        {{ (prop.purpose === 'ForRent' ? 'PROPERTY_VIEW.FOR_RENT' : 'PROPERTY_VIEW.FOR_SALE') | translate }}
                    </span>
                </div>
                <div class="card-content">
                    <h3 class="card-title">{{ getSimilarPropertyTitle(prop) }}</h3>
                    <p class="location"><i class="fa fa-map-marker-alt"></i> {{ getSimilarPropertyLocation(prop) }}</p>
                    
                    <div class="card-specs">
                        <div class="spec" *ngIf="prop.rooms">
                            <i class="fa fa-bed"></i> 
                            <span>{{ prop.rooms }}</span>
                        </div>
                        <div class="spec" *ngIf="prop.bathrooms">
                            <i class="fa fa-bath"></i> 
                            <span>{{ prop.bathrooms }}</span>
                        </div>
                        <div class="spec" *ngIf="prop.area">
                            <i class="fa fa-ruler-combined"></i> 
                            <span>{{ prop.area }} {{ 'PROPERTY_VIEW.SQ_M' | translate }}</span>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="price">
                            {{ prop.price | currency:(prop.currency || 'EGP'):'symbol':'1.0-0' }}
                        </div>
                        <div class="view-btn">
                            {{ 'PROPERTY_VIEW.VIEW_PROFILE' | translate }} <i class="fa fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>{{ 'PROPERTY_VIEW.LOADING' | translate }}</p>
</div>

<!-- Error State -->
<div class="error-state" *ngIf="errorMessage && !isLoading">
    <p>{{ errorMessage }}</p>
</div>