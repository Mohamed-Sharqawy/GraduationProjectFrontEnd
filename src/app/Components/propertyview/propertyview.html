<div class="property-container" *ngIf="!isLoading && !errorMessage">
    <!-- Image Slider with Navigation Arrows -->
    <div class="gallery-section" *ngIf="property && property.images && property.images.length > 0">
        <div class="image-slider">
            <img [src]="property.images[currentImageIndex].imageUrl"
                [alt]="title + ' - Image ' + (currentImageIndex + 1)" class="slider-image">

            <!-- Navigation Arrows -->
            <button class="slider-arrow prev" (click)="previousImage()" *ngIf="property.images.length > 1">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="slider-arrow next" (click)="nextImage()" *ngIf="property.images.length > 1">
                <i class="fas fa-chevron-right"></i>
            </button>

            <!-- Image Counter -->
            <span class="image-counter">{{ currentImageIndex + 1 }} / {{ property.images.length }}</span>

            <!-- Thumbnail Indicators -->
            <div class="thumbnail-indicators" *ngIf="property.images.length > 1">
                <div *ngFor="let img of property.images; let i = index" class="thumbnail-dot"
                    [class.active]="i === currentImageIndex" (click)="goToImage(i)">
                </div>
            </div>
        </div>
    </div>

    <div class="content-layout">
        <main class="property-details">
            <!-- Header Section -->
            <div class="header-section">
                <!-- Price -->
                <div class="price-row">
                    <h1>{{ price | currency: currency :'symbol':'1.0-0' }}</h1>
                    <span class="installment-tag" *ngIf="rentPriceMonthly > 0">
                        {{ rentPriceMonthly | currency: currency :'symbol':'1.0-0' }} {{ 'PROPERTY_VIEW.MONTHLY_RENT' |
                        translate }}
                    </span>
                    <span class="installment-tag" *ngIf="rentPriceMonthly === 0 && property?.purpose !== 'ForSale'">
                        {{ currency }} {{ installment }} / {{ installmentPeriod }}
                    </span>
                </div>

                <!-- Down Payment -->
                <div class="down-payment-row" *ngIf="rentPriceMonthly === 0 && property?.purpose !== 'ForSale'">
                    <span class="down-payment-badge">
                        üíµ {{ 'PROPERTY_VIEW.DOWN_PAYMENT' | translate }}: {{ currency }} {{ downPayment }}
                    </span>
                </div>

                <!-- Location -->
                <h2 class="location-title">{{ location }}</h2>

                <!-- Specs -->
                <div class="specs-horizontal">
                    <span class="spec-item" *ngIf="specs.beds > 0">
                        üõè {{ specs.beds }} {{ specs.beds > 1 ? ('PROPERTY_VIEW.BEDS' | translate) :
                        ('PROPERTY_VIEW.BED' | translate) }}
                    </span>
                    <span class="spec-item" *ngIf="specs.baths > 0">
                        üõÅ {{ specs.baths }} {{ specs.baths > 1 ? ('PROPERTY_VIEW.BATHS' | translate) :
                        ('PROPERTY_VIEW.BATH' | translate) }}
                    </span>
                    <span class="spec-item" *ngIf="specs.area > 0">
                        üìê {{ specs.area }} {{ 'PROPERTY_VIEW.SQ_M' | translate }}
                    </span>
                </div>

                <!-- Title & Description -->
                <div class="description-section">
                    <h3>{{ title }}</h3>
                    <ul class="desc-list" *ngIf="description.length > 0">
                        <li *ngFor="let line of description">{{ line }}</li>
                    </ul>
                </div>

                <!-- Property Info Table -->
                <section class="info-table">
                    <h3>{{ 'PROPERTY_VIEW.PROPERTY_INFO_TITLE' | translate }}</h3>
                    <div class="grid-info">
                        <div class="info-item" *ngFor="let item of propertySpecs">
                            <span class="label">{{ item.label }}</span>
                            <span class="value">{{ item.value }}</span>
                        </div>
                    </div>
                </section>

                <!-- Amenities -->
                <section class="amenities-section"
                    *ngIf="property && property.amenities && property.amenities.length > 0">
                    <h3>{{ 'PROPERTY_VIEW.AMENITIES_TITLE' | translate }}</h3>
                    <div class="amenities-grid">
                        <div class="amenity-item" *ngFor="let amenity of property.amenities">
                            <i class="fa fa-check-circle" style="color: #28b16d;"></i>
                            {{ currentLang === 'en' ? (amenity.nameEn || amenity.name) : amenity.name }}
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Agent Card -->
            <div class="broker-card">
                <div class="broker-header">
                    <img [src]="agent.imageUrl || 'https://via.placeholder.com/80'" [alt]="agent.name"
                        class="profile-pic">
                    <div class="broker-info">
                        <h3 class="agent-name" (click)="viewAgentProfile()"
                            style="cursor: pointer; color: #28b16d; margin: 0;">
                            {{ agent.name }}
                        </h3>
                        <p class="agent-stats">{{ agent.activeListings }} {{ 'PROPERTY_VIEW.ACTIVE_LISTINGS' | translate
                            }}</p>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn-call" (click)="callAgent()" *ngIf="agent.phone">
                        üìû {{ 'PROPERTY_VIEW.CALL' | translate }}
                    </button>
                    <button class="btn-email" (click)="emailAgent()" *ngIf="agent.email">
                        ‚úâ {{ 'PROPERTY_VIEW.EMAIL' | translate }}
                    </button>
                    <button class="btn-whatsapp" (click)="whatsappAgent()" *ngIf="agent.whatsapp">
                        üí¨ {{ 'PROPERTY_VIEW.WHATSAPP' | translate }}
                    </button>
                </div>
            </div>

            <!-- Save Property Button -->
            <div class="save-property-card">
                <button (click)="toggleSave()" class="save-btn" [class.saved]="isSaved">
                    <i class="fa" [class.fa-heart]="isSaved" [class.fa-heart-o]="!isSaved"></i>
                    {{ isSaved ? ('PROPERTY_VIEW.UNSAVE_PROPERTY' | translate) : ('PROPERTY_VIEW.SAVE_PROPERTY' |
                    translate) }}
                </button>
            </div>

            <!-- Analytics Card -->
            <div class="analytics-card">
                <h3>{{ 'PROPERTY_VIEW.ANALYTICS_TITLE' | translate }}</h3>
                <div class="analytics-content">
                    <div class="stat-item">
                        <i class="fa fa-eye pe-2"></i>
                        <span class="stat-label">{{ 'PROPERTY_VIEW.VIEWS' | translate }}</span>
                        <span class="stat-value">{{ viewCount }}</span>
                    </div>
                    <div class="stat-item">
                        <!-- <i class="fa fa-whatsapp pe-2"></i> -->
                        <i class="fa-brands fa-whatsapp pe-2"></i>
                        <span class="stat-label">{{ 'PROPERTY_VIEW.WHATSAPP_CLICKS' | translate }}</span>
                        <span class="stat-value">{{ whatsappClickCount }}</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Similar Properties Section -->
    <section class="similar-properties-section" *ngIf="similarProperties.length > 0">
        <h2 class="section-title">{{ 'PROPERTY_VIEW.RECOMMENDED' | translate }}</h2>
        <div class="properties-grid">
            <div class="property-card" *ngFor="let prop of similarProperties" [routerLink]="['/propertyview', prop.id]"
                (click)="incrementViewCount(prop.id)"> <!-- Track view when clicked -->
                <div class="card-image">
                    <img [src]="prop.mainImageUrl || 'https://via.placeholder.com/300x200'"
                        [alt]="getSimilarPropertyTitle(prop)">
                    <span class="badge" *ngIf="prop.isFeatured">‚≠ê {{ 'LISTING_PROPERTIES.FEATURED' | translate }}</span>
                    <span class="purpose-badge" [class.rent]="prop.purpose === 'ForRent'">
                        {{ (prop.purpose === 'ForRent' ? 'PROPERTY_VIEW.FOR_RENT' : 'PROPERTY_VIEW.FOR_SALE') |
                        translate }}
                    </span>
                </div>
                <div class="card-content">
                    <h3 class="card-title">{{ getSimilarPropertyTitle(prop) }}</h3>
                    <p class="location"><i class="fa fa-map-marker-alt"></i> {{ getSimilarPropertyLocation(prop) }}</p>

                    <div class="card-specs">
                        <div class="spec" *ngIf="prop.rooms">
                            <i class="fa fa-bed"></i>
                            <span>{{ prop.rooms }}</span>
                        </div>
                        <div class="spec" *ngIf="prop.bathrooms">
                            <i class="fa fa-bath"></i>
                            <span>{{ prop.bathrooms }}</span>
                        </div>
                        <div class="spec" *ngIf="prop.area">
                            <i class="fa fa-ruler-combined"></i>
                            <span>{{ prop.area }} {{ 'PROPERTY_VIEW.SQ_M' | translate }}</span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="price">
                            {{ prop.price | currency:(prop.currency || 'EGP'):'symbol':'1.0-0' }}
                        </div>
                        <div class="view-btn">
                            {{ 'PROPERTY_VIEW.VIEW_PROFILE' | translate }} <i class="fa fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>{{ 'PROPERTY_VIEW.LOADING' | translate }}</p>
</div>

<!-- Error State -->
<div class="error-state" *ngIf="errorMessage && !isLoading">
    <p>{{ errorMessage }}</p>
</div>

<!-- Call Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity"
    *ngIf="isCallModalOpen" (click)="closeCallModal()">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all scale-100"
        (click)="$event.stopPropagation()">
        <!-- Header -->
        <div class="bg-[#eef5f6] px-6 py-4 flex items-center justify-between border-b border-gray-200">
            <h3 class="text-lg font-bold text-[#0e5c65] flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd"
                        d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 5.25V4.5z"
                        clip-rule="evenodd" />
                </svg>
                {{ 'AGENT_PROFILE.CALL_AGENT' | translate }}
            </h3>
            <button (click)="closeCallModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Body -->
        <div class="p-6 text-center">
            <div class="w-16 h-16 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center text-3xl">
                üìû
            </div>
            <h4 class="text-xl font-bold text-gray-900 mb-1">{{ agent.name }}</h4>
            <p class="text-sm text-gray-500 mb-6">{{ 'AGENT_PROFILE.CALL_MODAL_DESC' | translate }}</p>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                <span class="text-lg font-mono font-bold text-gray-800 tracking-wider">{{ agent.phone }}</span>
                <button (click)="copyPhone()"
                    class="text-sm text-[#00423a] font-bold hover:underline ml-3 flex items-center gap-1">
                    <span *ngIf="isCopied" class="text-green-600 animate-fade-in">{{ 'COMMON.COPIED' | translate
                        }}</span>
                    <span *ngIf="!isCopied">{{ 'COMMON.COPY' | translate }}</span>
                </button>
            </div>

            <!-- Call Now button removed as per user request -->
            <div class="h-4"></div>
        </div>
    </div>
</div>