<div class="dashboard-container">
    <div class="dashboard-header">
        <div>
            <h1>{{ 'USER_DASHBOARD.DASHBOARD_TITLE' | translate }}</h1>
            <p style="color: #666; margin-top: 5px;">{{ 'USER_DASHBOARD.DASHBOARD_SUBTITLE' | translate }}</p>
        </div>
        <button class="add-btn" (click)="addProperty()">
            <span style="font-size: 20px;">+</span> {{ 'USER_DASHBOARD.ADD_NEW_PROPERTY' | translate }}
        </button>
    </div>

    @if (needsLogin) {
    <div style="text-align: center; padding: 50px; background: white; border-radius: 8px;">
        <p style="font-size: 24px; margin-bottom: 10px;">üîí</p>
        <p style="font-size: 18px; color: #666; margin-bottom: 5px;">{{ 'USER_DASHBOARD.LOGIN_REQUIRED_TITLE' |
            translate }}</p>
        @if (errorMessage) {
        <p style="font-size: 14px; color: #c62828;">{{ errorMessage }}</p>
        }
        <button class="add-btn" style="margin-top: 20px;" (click)="goToLogin()">{{ 'USER_DASHBOARD.GO_TO_LOGIN' |
            translate }}</button>
    </div>
    } @else if (errorMessage) {
    <div
        style="text-align: center; padding: 20px; margin: 20px; background: #ffebee; color: #c62828; border-radius: 8px; border: 1px solid #ef9a9a;">
        <p style="margin: 0; font-weight: bold;">{{ 'USER_DASHBOARD.ERROR_TITLE' | translate }}</p>
        <p style="margin: 5px 0 0 0;">{{ errorMessage }}</p>
        <button (click)="loadProperties()" style="margin-top: 10px; padding: 5px 15px; cursor: pointer;">{{
            'USER_DASHBOARD.RETRY' | translate }}</button>
    </div>
    } @else if (isLoading) {
    <div style="text-align: center; padding: 50px;">
        <p style="font-size: 18px; color: #666;">{{ 'COMMON.LOADING' | translate }}</p>
    </div>
    } @else if (userProperties.length === 0) {
    <div style="text-align: center; padding: 50px; background: white; border-radius: 8px;">
        <p style="font-size: 18px; color: #666;">{{ 'USER_DASHBOARD.NO_PROPERTIES' | translate }}</p>
        <button class="add-btn" style="margin: 20px auto;" (click)="addProperty()">{{
            'USER_DASHBOARD.CREATE_FIRST_LISTING' | translate }}</button>
    </div>
    } @else {
    <div class="properties-grid">
        @for (prop of userProperties; track prop.id) {
        <div class="property-card">
            <div class="card-image">
                <img [src]="prop.primaryImageUrl || 'https://placehold.co/600x400?text=No+Image'" [alt]="prop.title">
                <span
                    style="position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white;"
                    [style.background]="(prop.status === 'Active') ? '#4caf50' : 
                                      (prop.status === 'Rejected') ? '#f44336' : 
                                      (prop.status === 'Hidden') ? '#9e9e9e' : '#ff9800'">
                    {{(
                        (prop.status === 'Active') ? 'USER_DASHBOARD.ACTIVE' :
                        (prop.status === 'Rejected') ? 'USER_DASHBOARD.REJECTED' :
                        (prop.status === 'Hidden') ? 'USER_DASHBOARD.HIDDEN' :
                        'USER_DASHBOARD.PENDING'
                    ) | translate}}
                </span>
            </div>
            <div class="card-content">
                <h3 class="card-title">{{translationService.currentLang === 'en' && prop.titleEn ? prop.titleEn : prop.title}}</h3>
                
                @if (prop.status === 'Rejected') {
                <div style="background: #ffebee; color: #c62828; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 8px; border: 1px solid #ef9a9a;">
                    <strong>{{ 'USER_DASHBOARD.REASON' | translate }}:</strong> {{prop.rejectionReason}}
                </div>
                }

                <div class="card-price">{{prop.price | currency : 'EGP' : 'symbol' : '1.0-0'}}</div>

                <div class="card-details">
                    <div class="detail-item"><i class="fa fa-door-open"></i> {{prop.rooms || 0}} {{ 'USER_DASHBOARD.ROOMS' | translate }}</div>
                    <div class="detail-item"><i class="fa fa-bath"></i> {{prop.bathrooms || 0}} {{ 'USER_DASHBOARD.BATHS' | translate }}</div>
                    <div class="detail-item"><i class="fa fa-arrows-alt"></i> {{prop.area}} {{ 'USER_DASHBOARD.SQM' | translate }}</div>
                </div>

                <div style="margin-top: auto; display: flex; align-items: center; color: #666; font-size: 13px;">
                    üìç {{getPropertyLocation(prop)}}
                </div>
            </div>
            <div class="card-actions">
                <button class="action-btn edit-btn" (click)="editProperty(prop.id)">‚úé {{ 'USER_DASHBOARD.EDIT' |
                    translate }}</button>
                <button class="action-btn delete-btn" (click)="deleteProperty(prop.id)">üóë {{ 'USER_DASHBOARD.DELETE' |
                    translate }}</button>
            </div>
        </div>
        }
    </div>
    }
</div>

<!-- Add/Edit Modal -->
@if (isFormVisible) {
<div class="modal-overlay" (click)="cancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ (isEditing ? 'USER_DASHBOARD.EDIT_PROPERTY' : 'USER_DASHBOARD.ADD_PROPERTY_TITLE') | translate }}
            </h2>
            <button class="close-btn" (click)="cancel()">√ó</button>
        </div>

        <form (ngSubmit)="saveProperty()">
            <div class="form-group">
                <label>{{ 'USER_DASHBOARD.PROPERTY_TITLE_AR' | translate }}</label>
                <input type="text" class="form-control" [(ngModel)]="currentProperty.Title" name="Title"
                    [placeholder]="'USER_DASHBOARD.PROPERTY_TITLE_AR_PLACEHOLDER' | translate" 
                    [class.is-invalid]="validationErrors.Title" required>
                @if (validationErrors.Title) {
                    <small class="error-message">{{ validationErrors.Title }}</small>
                }
            </div>
            <div class="form-group">
                <label>{{ 'USER_DASHBOARD.PROPERTY_TITLE_EN' | translate }}</label>
                <input type="text" class="form-control" [(ngModel)]="currentProperty.TitleEn" name="TitleEn"
                    [placeholder]="'USER_DASHBOARD.PROPERTY_TITLE_EN_PLACEHOLDER' | translate">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.PRICE' | translate }}</label>
                    <input type="number" class="form-control" [(ngModel)]="currentProperty.Price" name="Price" required
                        min="1" [disabled]="isEditing" [class.is-invalid]="validationErrors.Price">
                    @if (validationErrors.Price) {
                        <small class="error-message">{{ validationErrors.Price }}</small>
                    }
                </div>
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.AREA' | translate }}</label>
                    <input type="number" class="form-control" [(ngModel)]="currentProperty.Area" name="Area" required
                        min="1" [disabled]="isEditing" [class.is-invalid]="validationErrors.Area">
                    @if (validationErrors.Area) {
                        <small class="error-message">{{ validationErrors.Area }}</small>
                    }
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.CITY' | translate }} *</label>
                    <input type="text" class="form-control search-input" [(ngModel)]="citySearchTerm"
                        (input)="filterCities()" placeholder="{{ 'USER_DASHBOARD.SEARCH_CITY' | translate }}"
                        name="citySearch" [disabled]="isEditing">
                    <select class="form-control" [(ngModel)]="currentProperty.CityId" name="CityId"
                        (change)="onCityChange(currentProperty.CityId)" required [disabled]="isEditing"
                        [class.is-invalid]="validationErrors.CityId">
                        <option [ngValue]="null" disabled selected>{{ 'USER_DASHBOARD.SELECT_CITY' | translate }}
                        </option>
                        @if (isLoadingCities) {
                        <option disabled>{{ 'COMMON.LOADING' | translate }}...</option>
                        }
                        @for (city of filteredCities; track city.id) {
                        <option [value]="city.id">{{city.name}} {{city.nameEn ? '(' + city.nameEn + ')' : ''}}</option>
                        }
                    </select>
                    @if (validationErrors.CityId) {
                        <small class="error-message">{{ validationErrors.CityId }}</small>
                    }
                </div>
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.DISTRICT' | translate }}</label>
                    <input type="text" class="form-control search-input" [(ngModel)]="districtSearchTerm"
                        (input)="filterDistricts()" placeholder="{{ 'USER_DASHBOARD.SEARCH_DISTRICT' | translate }}"
                        [disabled]="!currentProperty.CityId || isEditing" name="districtSearch">
                    <select class="form-control" [(ngModel)]="currentProperty.DistrictId" name="DistrictId"
                        [disabled]="!currentProperty.CityId || isLoadingDistricts || isEditing"
                        (change)="onDistrictChange(currentProperty.DistrictId)">
                        <option [ngValue]="null">{{ 'USER_DASHBOARD.SELECT_DISTRICT' | translate }}</option>
                        @if (isLoadingDistricts) {
                        <option disabled>{{ 'COMMON.LOADING' | translate }}...</option>
                        }
                        @for (district of filteredDistricts; track district.id) {
                        <option [value]="district.id">{{district.name}} {{district.nameEn ? '(' + district.nameEn + ')'
                            : ''}}</option>
                        }
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.PROJECT' | translate }}</label>
                    <input type="text" class="form-control search-input" [(ngModel)]="projectSearchTerm"
                        (input)="filterProjects()" placeholder="{{ 'USER_DASHBOARD.SEARCH_PROJECT' | translate }}"
                        name="projectSearch" [disabled]="isEditing">
                    <select class="form-control" [(ngModel)]="currentProperty.ProjectId" name="ProjectId" [disabled]="isEditing">
                        <option [ngValue]="null">{{ 'USER_DASHBOARD.SELECT_PROJECT' | translate }}</option>
                        @if (isLoadingProjects) {
                        <option disabled>{{ 'COMMON.LOADING' | translate }}...</option>
                        }
                        @for (project of filteredProjects; track project.id) {
                        <option [value]="project.id">{{project.name}} - {{project.cityName}}</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.ADDRESS_DETAILS' | translate }}</label>
                    <input type="text" class="form-control" [(ngModel)]="currentProperty.AddressDetails"
                        name="AddressDetails"
                        placeholder="{{ 'USER_DASHBOARD.ADDRESS_DETAILS_PLACEHOLDER' | translate }}" [disabled]="isEditing">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.PROPERTY_TYPE' | translate }} *</label>
                    <input type="text" class="form-control search-input" [(ngModel)]="propertyTypeSearchTerm"
                        (input)="filterPropertyTypes()"
                        placeholder="{{ 'USER_DASHBOARD.SEARCH_PROPERTY_TYPE' | translate }}" name="propertyTypeSearch" [disabled]="isEditing">
                    <select class="form-control" [(ngModel)]="currentProperty.PropertyTypeId" name="PropertyTypeId"
                        required [disabled]="isEditing" [class.is-invalid]="validationErrors.PropertyTypeId">
                        <option [ngValue]="null" disabled selected>{{ 'USER_DASHBOARD.SELECT_TYPE' | translate }}
                        </option>
                        @if (isLoadingPropertyTypes) {
                        <option disabled>{{ 'COMMON.LOADING' | translate }}...</option>
                        }
                        @for (type of filteredPropertyTypes; track type.id) {
                        <option [value]="type.id">{{type.name}} {{type.nameEn ? '(' + type.nameEn + ')' : ''}}</option>
                        }
                    </select>
                    @if (validationErrors.PropertyTypeId) {
                        <small class="error-message">{{ validationErrors.PropertyTypeId }}</small>
                    }
                </div>
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.PURPOSE' | translate }} *</label>
                    <select class="form-control" [(ngModel)]="currentProperty.Purpose" name="Purpose" required [disabled]="isEditing"
                        [class.is-invalid]="validationErrors.Purpose">
                        <option [value]="1">{{ 'USER_DASHBOARD.FOR_SALE' | translate }}</option>
                        <option [value]="2">{{ 'USER_DASHBOARD.FOR_RENT' | translate }}</option>
                        <option [value]="3">{{ 'USER_DASHBOARD.FOR_BOTH' | translate }}</option>
                    </select>
                    @if (validationErrors.Purpose) {
                        <small class="error-message">{{ validationErrors.Purpose }}</small>
                    }
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.BEDROOMS' | translate }}</label>
                    <input type="number" class="form-control" [(ngModel)]="currentProperty.Rooms" name="Rooms" min="0" [disabled]="isEditing">
                </div>
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.BATHROOMS' | translate }}</label>
                    <input type="number" class="form-control" [(ngModel)]="currentProperty.Bathrooms" name="Bathrooms"
                        min="0" [disabled]="isEditing">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.FLOOR_NUMBER' | translate }}</label>
                    <input type="number" class="form-control" [(ngModel)]="currentProperty.FloorNumber"
                        name="FloorNumber" min="0" [disabled]="isEditing">
                </div>
                <div class="form-group">
                    <label>{{ 'USER_DASHBOARD.FINISHING_TYPE' | translate }}</label>
                    <select class="form-control" [(ngModel)]="currentProperty.FinishingType" name="FinishingType" [disabled]="isEditing">
                        <option [value]="0">{{ 'USER_DASHBOARD.NO_FINISHING' | translate }}</option>
                        <option [value]="1">{{ 'USER_DASHBOARD.SEMI_FINISHING' | translate }}</option>
                        <option [value]="2">{{ 'USER_DASHBOARD.FULL_FINISHING' | translate }}</option>
                        <!-- <option [value]="3">{{ 'USER_DASHBOARD.SUPER_LUX' | translate }}</option> -->
                    </select>
                </div>
            </div>

            <!-- Show Rent Price only if Purpose is Rent (2) or Both (3) -->
            @if (+currentProperty.Purpose === 2 || +currentProperty.Purpose === 3) {
            <div class="form-group">
                <label>{{ 'USER_DASHBOARD.RENT_PRICE_MONTHLY' | translate }} *</label>
                <input type="number" class="form-control" [(ngModel)]="currentProperty.RentPriceMonthly"
                    name="RentPriceMonthly" min="0" required [disabled]="isEditing"
                    placeholder="{{ 'USER_DASHBOARD.RENT_PRICE_PLACEHOLDER' | translate }}"
                    [class.is-invalid]="validationErrors.RentPriceMonthly">
                @if (validationErrors.RentPriceMonthly) {
                    <small class="error-message">{{ validationErrors.RentPriceMonthly }}</small>
                }
            </div>
            }

            <div class="form-group">
                <label>{{ 'USER_DASHBOARD.DESCRIPTION_AR' | translate }}</label>
                <textarea class="form-control" [(ngModel)]="currentProperty.Description" name="Description" rows="3"
                    placeholder="{{ 'USER_DASHBOARD.DESCRIPTION_PLACEHOLDER' | translate }}"
                    [class.is-invalid]="validationErrors.Description"></textarea>
                @if (validationErrors.Description) {
                    <small class="error-message">{{ validationErrors.Description }}</small>
                }
            </div>

            <div class="form-group">
                <label>{{ 'USER_DASHBOARD.DESCRIPTION_EN' | translate }}</label>
                <textarea class="form-control" [(ngModel)]="currentProperty.DescriptionEn" name="DescriptionEn" rows="3"
                    placeholder="{{ 'USER_DASHBOARD.DESCRIPTION_EN_PLACEHOLDER' | translate }}"></textarea>
            </div>

            <!-- Featured Property Checkbox (only when creating new property) -->
            @if (!isEditing) {
            <div class="form-group full-width">
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="currentProperty.IsFeatured" name="IsFeatured">
                    <span>{{ 'USER_DASHBOARD.IS_FEATURED' | translate }}</span>
                </label>
                <small style="color: #666; display: block; margin-top: 5px;">
                    {{ 'USER_DASHBOARD.FEATURED_NOTE' | translate }}
                </small>
            </div>
            }

            @if (!isEditing) {
            <div class="form-group">
                <label>{{ 'USER_DASHBOARD.IMAGES' | translate }} *</label>
                <input type="file" class="form-control" multiple (change)="onFileSelect($event)" accept="image/*"
                    [class.is-invalid]="validationErrors.Images">
                <small style="color: #666; display: block; margin-top: 5px;">{{ 'USER_DASHBOARD.IMAGES_NOTE' | translate
                    }}</small>
                @if (validationErrors.Images) {
                    <small class="error-message">{{ validationErrors.Images }}</small>
                }
            </div>
            }

            <div class="modal-footer">
                <button type="button" class="btn-cancel" (click)="cancel()" [disabled]="isSaving">{{ 'USER_DASHBOARD.CANCEL' | translate
                    }}</button>
                <button type="submit" class="btn-save" [disabled]="isSaving">
                    @if (isSaving) {
                        <span>{{ 'USER_DASHBOARD.SAVING' | translate }}...</span>
                    } @else {
                        {{ 'USER_DASHBOARD.SAVE_PROPERTY' | translate }}
                    }
                </button>
            </div>
        </form>
    </div>
</div>
}